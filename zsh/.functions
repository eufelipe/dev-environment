# ------------------------------------------------------------------------------
# UTILIT√ÅRIOS DO SISTEMA
# ------------------------------------------------------------------------------

# search: Procura recursivamente por um arquivo cujo nome corresponda ao primeiro argumento
#         e, dentro dele, busca um texto passado como segundo argumento, listando os arquivos que cont√™m o padr√£o.
search() {
  # Executa find no diret√≥rio atual (.)
  # -type f: procura somente arquivos
  # -name "$1": filtra arquivos pelo nome informado como primeiro par√¢metro
  # -exec grep -l "$2" {} \;: para cada arquivo encontrado, usa grep para listar (-l) os que cont√™m o texto ($2)
  find . -type f -name "$1" -exec grep -l "$2" {} \;
}

# dirsize: Exibe o tamanho dos diret√≥rios de forma leg√≠vel.
dirsize() {
  # du -h: calcula o uso de disco em formato "human readable"
  # --max-depth=1: limita a profundidade de listagem a 1 n√≠vel
  # "$@": permite passar um ou mais diret√≥rios como argumento
  # sort -hr: ordena os resultados em ordem decrescente (h: human readable, r: reverso)
  du -h --max-depth=1 "$@" | sort -hr
}

# cleanup_ds_store: Remove recursivamente todos os arquivos .DS_Store.
cleanup_ds_store() {
  # find: busca arquivos com nome .DS_Store no diret√≥rio atual
  # -type f: garante que s√£o arquivos
  # -delete: remove os arquivos encontrados
  find . -name ".DS_Store" -type f -delete
}

# backup: Cria uma c√≥pia de backup de um arquivo, anexando data e hora ao nome.
backup() {
  # cp: copia o arquivo ($1) para um novo nome, que inclui a data e hora atual (formato YYYYMMDD_HHMMSS)
  cp "$1" "$1.bak.$(date +%Y%m%d_%H%M%S)"
}

# ------------------------------------------------------------------------------
# NAVEGA√á√ÉO
# ------------------------------------------------------------------------------

# up: Navega para cima na hierarquia de diret√≥rios m√∫ltiplas vezes.
up() {
    # Inicializa a vari√°vel que ir√° acumular os "../"
    local d=""
    # Define o limite (n√∫mero de n√≠veis) a partir do primeiro argumento
    local limit=$1

    # Se nenhum argumento for passado, define o padr√£o como 1
    [ -z "$limit" ] && limit=1

    # Loop para concatenar "../" conforme o n√∫mero de n√≠veis desejado
    for ((i=1; i <= limit; i++)); do
      d="$d../"
    done

    # Se, por algum motivo, 'd' estiver vazia, define como um √∫nico n√≠vel para garantir
    if [ -z "$d" ]; then
      d=".."
    fi

    # Muda para o diret√≥rio constru√≠do; se falhar, retorna sem erro
    cd "$d" || return
}

# path: Exibe os caminhos do PATH em linhas separadas para melhor visualiza√ß√£o.
path() {
  # Substitui os ":" por quebras de linha
  echo $PATH | tr ":" "\n"
}

# ------------------------------------------------------------------------------
# DESENVOLVIMENTO WEB/MOBILE
# ------------------------------------------------------------------------------

apocalipse() {
  echo "üíÄ Iniciando o Apocalipse do projeto..."

  echo "üßπ Removendo node_modules e arquivos de lock..."
  rm -rf node_modules package-lock.json yarn.lock pnpm-lock.yaml

  echo "üßº Limpando caches..."
  command -v npm >/dev/null && npm cache clean --force
  command -v yarn >/dev/null && yarn cache clean
  command -v pnpm >/dev/null && pnpm store prune

  echo "üì¶ Instalando depend√™ncias novamente..."
  if [ -f pnpm-lock.yaml ]; then
    pnpm install
  elif [ -f yarn.lock ]; then
    yarn install
  else
    npm install
  fi

  if [ -d ios ]; then
    echo "üçè Limpando Pods..."
    cd ios
    rm -rf Pods Podfile.lock
    pod cache clean --all
    pod install
    cd ..
  fi

  if [ -d ~/Library/Developer/Xcode/DerivedData ]; then
    echo "üß† Limpando DerivedData..."
    rm -rf ~/Library/Developer/Xcode/DerivedData/*
  fi

  command -v watchman >/dev/null && watchman watch-del-all

  echo "‚úÖ Apocalipse finalizado. Projeto limpo e purificado com sucesso."
}




# npm_clean: Limpa o cache do NPM, remove os diret√≥rios e arquivos de depend√™ncias e reinstala tudo.
npm_clean() {
    # Limpa o cache do NPM for√ßando a opera√ß√£o
    npm cache clean --force
    # Remove o diret√≥rio node_modules
    rm -rf node_modules
    # Remove o arquivo de bloqueio de vers√µes
    rm package-lock.json
    # Reinstala as depend√™ncias definidas no package.json
    npm install
}

yarn_clean() {
  yarn cache clean
  rm -rf node_modules
  rm yarn.lock
  yarn install
}

# pnpm_clean: Limpa o cache do PNPM, remove os diret√≥rios e arquivos de depend√™ncias e reinstala tudo.
pnpm_clean() {
  pnpm store prune
  pnpm cache clean --all
  pnpm install
}

# ios_simulator: Abre o simulador do iOS.
ios_simulator() {
  # Abre o aplicativo Simulator (padr√£o no macOS)
  open -a Simulator
}

# port_check: Verifica se uma determinada porta (passada como argumento) est√° em uso.
port_check() {
  # Usa lsof para listar processos que est√£o utilizando a porta especificada
  lsof -i :"$1"
}

# ------------------------------------------------------------------------------
# PRODUTIVIDADE
# ------------------------------------------------------------------------------

# mkcd: Cria um diret√≥rio e entra nele de uma s√≥ vez.
mkcd() {
  # Cria o diret√≥rio, incluindo quaisquer diret√≥rios pai que n√£o existam (-p)
  mkdir -p "$1"
  # Entra no diret√≥rio criado; se falhar, encerra o script com exit
  cd "$1" || exit
}

# extract: Extrai automaticamente arquivos compactados de diversos formatos.
extract() {
  # Verifica se o primeiro argumento √© um arquivo existente
  if [ -f "$1" ] ; then
    # Seleciona a a√ß√£o de extra√ß√£o com base na extens√£o do arquivo
    case "$1" in
      *.tar.bz2)   tar xjf "$1"   ;;  # Extrai arquivos tar.bz2
      *.tar.gz)    tar xzf "$1"   ;;  # Extrai arquivos tar.gz
      *.bz2)       bunzip2 "$1"   ;;  # Descompacta arquivos bz2
      *.rar)       unrar x "$1"   ;;  # Extrai arquivos rar
      *.gz)        gunzip "$1"    ;;  # Descompacta arquivos gz
      *.tar)       tar xf "$1"    ;;  # Extrai arquivos tar
      *.tbz2)      tar xjf "$1"   ;;  # Extrai arquivos tar.bz2 (varia√ß√£o)
      *.tgz)       tar xzf "$1"   ;;  # Extrai arquivos tgz
      *.zip)       unzip "$1"     ;;  # Extrai arquivos zip
      *.Z)         uncompress "$1";;  # Descompacta arquivos Z
      *.7z)        7z x "$1"      ;;  # Extrai arquivos 7z
      *)           echo "'$1' n√£o pode ser extra√≠do via extract()" ;;  # Caso n√£o reconhe√ßa o formato
    esac
  else
    # Se o arquivo n√£o existir ou n√£o for v√°lido, exibe uma mensagem de erro
    echo "'$1' n√£o √© um arquivo v√°lido"
  fi
}

# gsync: Sincroniza rapidamente um reposit√≥rio Git.
gsync() {
  # Atualiza o reposit√≥rio com pull rebase para integrar as mudan√ßas
  git pull --rebase
  # Envia as mudan√ßas locais para o reposit√≥rio remoto
  git push
}

# gpullall: Atualiza (faz pull) de todos os reposit√≥rios Git dentro de um diret√≥rio.
gpullall() {
  # Itera por cada subdiret√≥rio
  for dir in */; do
    # Verifica se o diret√≥rio cont√©m um reposit√≥rio Git (existe a pasta .git)
    if [ -d "$dir/.git" ]; then
      echo "Atualizando $dir"
      # Entra no diret√≥rio, executa pull rebase e retorna ao diret√≥rio original
      (cd "$dir" && git pull --rebase)
    fi
  done
}

# killport: Mata o processo que est√° usando a porta especificada.
killport() {
  # Verifica se o usu√°rio passou o n√∫mero da porta
  if [ -z "$1" ]; then
    echo "Uso: killport <porta>"
  else
    # Encontra o PID do processo usando a porta e o mata com sinal 9 (force kill)
    lsof -t -i :"$1" | xargs kill -9
  fi
}

# ------------------------------------------------------------------------------
# GIT
# ------------------------------------------------------------------------------

# fork: Clona um reposit√≥rio e o coloca em um diret√≥rio destinado a forks.
fork() {
  # Extrai o nome do reposit√≥rio a partir da URL fornecida (remove caminho e extens√£o)
  repo_name=$(echo "$1" | xargs basename | cut -d. -f1)
  # Define o caminho onde o fork ser√° clonado
  clone_path="$HOME/PROJETOS/CODE/forks/$repo_name"
  # Informa ao usu√°rio onde o fork ser√° clonado
  echo "Seu fork ser√° clonado para $clone_path"
  # Clona o reposit√≥rio para o diret√≥rio definido
  git clone $1 "$clone_path"
  # Entra no diret√≥rio clonado
  cd $clone_path
}